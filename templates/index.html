<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kapoptimering | Hyllteknik</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --black: #1a1a1a;
            --white: #ffffff;
            --red: #c41e3a;
            --gray-100: #f7f7f7;
            --gray-200: #e5e5e5;
            --gray-300: #d4d4d4;
            --gray-400: #a3a3a3;
            --gray-500: #737373;
            --gray-600: #525252;
            --gray-700: #404040;
            --green: #16a34a;
            --blue: #2563eb;
            --orange: #ea580c;
            --purple: #7c3aed;
            --teal: #0d9488;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-100);
            color: var(--black);
            line-height: 1.5;
            font-size: 15px;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Header */
        header {
            display: flex;
            flex-direction: column;
            margin-bottom: 40px;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px 0;
            gap: 32px;
        }

        .header-logos {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .header-logos img:first-child {
            height: 48px;
        }

        .header-logos .ael-logo {
            height: 56px;
        }

        .logo-separator {
            color: var(--gray-400);
            font-size: 24px;
            font-weight: 300;
        }

        .header-divider {
            height: 1px;
            background: var(--gray-200);
            width: 100%;
        }

        .header-bottom {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
        }

        header .tagline {
            font-size: 15px;
            font-weight: 600;
            color: var(--black);
            letter-spacing: 1.5px;
            text-transform: uppercase;
        }

        header .header-nav {
            margin-left: auto;
        }

        .lang-switcher {
            font-size: 13px;
            color: var(--gray-500);
        }

        .lang-switcher a {
            color: var(--gray-500);
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s;
        }

        .lang-switcher a:hover {
            color: var(--black);
        }

        .lang-switcher a.active {
            color: var(--black);
            font-weight: 600;
        }

        .lang-switcher .separator {
            margin: 0 6px;
        }

        .header-nav {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-link {
            font-size: 13px;
            color: var(--gray-600);
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s;
            font-weight: 500;
        }

        .nav-link:hover {
            color: var(--black);
        }

        .nav-link.active {
            color: var(--black);
            font-weight: 600;
        }

        .nav-separator {
            color: var(--gray-300);
        }

        /* About Section */
        .about-section {
            display: none;
            background: var(--white);
            border: 1px solid var(--gray-200);
            margin-bottom: 24px;
            padding: 40px;
        }

        .about-section.visible {
            display: block;
        }

        .about-hero {
            text-align: center;
            margin-bottom: 48px;
        }

        .about-hero h2 {
            font-size: 28px;
            font-weight: 700;
            color: var(--black);
            margin-bottom: 12px;
        }

        .about-hero p {
            font-size: 16px;
            color: var(--gray-600);
            max-width: 600px;
            margin: 0 auto;
        }

        .about-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 48px;
        }

        .stat-card {
            background: var(--gray-100);
            padding: 28px;
            text-align: center;
        }

        .stat-card .icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: 700;
            color: var(--black);
            line-height: 1;
        }

        .stat-card .label {
            font-size: 13px;
            color: var(--gray-600);
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .about-sections {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 32px;
            margin-bottom: 48px;
        }

        .about-card {
            padding: 24px;
            border: 1px solid var(--gray-200);
        }

        .about-card h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--black);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .about-card h3 .icon {
            font-size: 20px;
        }

        .about-card ul {
            list-style: none;
            padding: 0;
        }

        .about-card li {
            padding: 8px 0;
            color: var(--gray-600);
            font-size: 14px;
            border-bottom: 1px solid var(--gray-100);
        }

        .about-card li:last-child {
            border-bottom: none;
        }

        .about-collab {
            text-align: center;
            padding: 32px;
            background: var(--gray-100);
        }

        .about-collab h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 24px;
        }

        .collab-logos {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 48px;
            margin-bottom: 20px;
        }

        .collab-logos img {
            height: 40px;
            width: auto;
        }

        .collab-logos .plus {
            font-size: 24px;
            color: var(--gray-400);
            font-weight: 300;
        }

        .about-collab p {
            font-size: 14px;
            color: var(--gray-600);
            max-width: 500px;
            margin: 0 auto;
        }

        .about-back {
            text-align: center;
            margin-top: 32px;
        }

        .about-back button {
            background: var(--black);
            color: var(--white);
            border: none;
            padding: 14px 32px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .about-back button:hover {
            background: var(--gray-700);
        }

        .about-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 28px;
            color: var(--gray-400);
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .about-close:hover {
            color: var(--black);
        }

        .about-section {
            position: relative;
        }

        /* Cards */
        .card {
            background: var(--white);
            padding: 32px;
            margin-bottom: 24px;
            border: 1px solid var(--gray-200);
        }

        .card-header {
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--gray-500);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--gray-200);
        }

        /* Form Elements */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 12px;
            font-weight: 500;
            color: var(--gray-600);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input {
            padding: 12px 14px;
            border: 1px solid var(--gray-300);
            font-size: 15px;
            font-family: inherit;
            transition: border-color 0.2s;
            background: var(--white);
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--black);
        }

        .form-group input::placeholder {
            color: var(--gray-400);
        }

        /* Items List */
        .items-header {
            display: grid;
            grid-template-columns: 1fr 1fr 50px;
            gap: 16px;
            margin-bottom: 8px;
        }

        .items-header span {
            font-size: 12px;
            font-weight: 500;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .item-row {
            display: grid;
            grid-template-columns: 1fr 1fr 50px;
            gap: 16px;
            margin-bottom: 8px;
            align-items: center;
        }

        .item-row input {
            padding: 12px 14px;
            border: 1px solid var(--gray-300);
            font-size: 15px;
            font-family: inherit;
        }

        .item-row input:focus {
            outline: none;
            border-color: var(--black);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: var(--black);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--gray-700);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--black);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover {
            border-color: var(--black);
        }

        .btn-remove {
            background: none;
            border: 1px solid var(--gray-300);
            color: var(--gray-500);
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
        }

        .btn-remove:hover {
            border-color: var(--red);
            color: var(--red);
        }

        .btn-add {
            background: none;
            border: 1px dashed var(--gray-300);
            color: var(--gray-500);
            padding: 12px;
            width: 100%;
            margin-top: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
        }

        .btn-add:hover {
            border-color: var(--black);
            color: var(--black);
        }

        .btn-run {
            width: 100%;
            padding: 18px;
            font-size: 15px;
            background: var(--red);
            color: var(--white);
            border: none;
        }

        .btn-run:hover {
            background: #a31830;
        }

        /* Results */
        #results {
            display: none;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background: var(--gray-200);
            border: 1px solid var(--gray-200);
        }

        .summary-item {
            background: var(--white);
            padding: 24px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .summary-item .value {
            font-size: 32px;
            font-weight: 700;
            color: var(--black);
            line-height: 1;
        }

        .summary-item .label {
            font-size: 11px;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 8px;
        }

        /* D√∂lj separator och parameter-boxar p√• sk√§rm */
        .summary-separator {
            display: none;
        }

        .summary-item.print-only {
            display: none;
        }

        .summary-material .value {
            font-size: 18px;
            font-weight: 700;
        }

        .summary-material .label {
            font-size: 11px;
            text-transform: none;
        }

        /* Pattern Cards */
        .pattern-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            margin-bottom: 16px;
        }

        .pattern-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-200);
        }

        .pattern-header h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--black);
        }

        .pattern-count {
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-600);
        }

        .pattern-count span {
            background: var(--black);
            color: var(--white);
            padding: 4px 12px;
            margin-left: 8px;
        }

        /* Tube Visualization */
        .tube-visual {
            position: relative;
            height: 56px;
            background: var(--gray-200);
            margin: 20px;
            border: 1px solid var(--gray-300);
        }

        .tube-piece {
            position: absolute;
            top: 0;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 600;
            font-size: 11px;
            border-right: 1px solid rgba(255,255,255,0.3);
            min-width: 2px;
            overflow: hidden;
        }

        .tube-piece-label {
            white-space: nowrap;
            padding: 0 4px;
        }

        .tube-waste {
            position: absolute;
            top: 0;
            height: 100%;
            background: repeating-linear-gradient(
                -45deg,
                #e0e0e0,
                #e0e0e0 3px,
                #d0d0d0 3px,
                #d0d0d0 6px
            );
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-600);
            font-size: 10px;
            font-weight: 500;
        }

        .tube-waste span {
            background: rgba(255,255,255,0.8);
            padding: 2px 6px;
        }

        .tube-fixture {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            background: var(--gray-600);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 0.5px;
            min-width: 30px;
            border-left: 2px solid var(--gray-700);
        }

        /* Annotations for narrow segments */
        .tube-annotations {
            position: relative;
            height: 20px;
            margin: 0 20px;
        }

        .tube-annotation {
            position: absolute;
            transform: translateX(-50%);
            text-align: center;
        }

        .annotation-line {
            width: 1px;
            height: 8px;
            background: var(--gray-500);
            margin: 0 auto;
        }

        .annotation-text {
            font-size: 9px;
            font-weight: 600;
            color: var(--gray-700);
            white-space: nowrap;
        }

        /* Grouped pieces legend */
        .tube-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 12px 20px;
            background: var(--gray-100);
            border-top: 1px solid var(--gray-200);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
        }

        /* Colors for pieces */
        .color-0 { background: var(--black); }
        .color-1 { background: var(--red); }
        .color-2 { background: var(--blue); }
        .color-3 { background: var(--orange); }
        .color-4 { background: var(--teal); }
        .color-5 { background: var(--purple); }

        .pattern-info {
            display: flex;
            gap: 32px;
            padding: 16px 20px;
            font-size: 13px;
            color: var(--gray-600);
            border-top: 1px solid var(--gray-200);
        }

        .pattern-info strong {
            color: var(--black);
        }

        /* Verification */
        .verification-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid var(--gray-200);
        }

        .verification-item:last-child {
            border-bottom: none;
        }

        .verification-item.ok {
            border-left: 3px solid var(--green);
        }

        .verification-item.error {
            border-left: 3px solid var(--red);
        }

        .check-icon {
            font-weight: 600;
        }

        .check-icon.ok { color: var(--green); }
        .check-icon.error { color: var(--red); }

        /* Suggestions */
        .suggestions-intro {
            padding: 16px;
            background: #fff8e6;
            border-left: 3px solid #f0ad4e;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .suggestion-item {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 16px;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--gray-200);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-main {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .suggestion-title {
            font-weight: 600;
            color: var(--black);
        }

        .suggestion-detail {
            font-size: 13px;
            color: var(--gray-500);
        }

        .suggestion-improvement {
            text-align: right;
        }

        .suggestion-improvement .value {
            font-size: 18px;
            font-weight: 700;
            color: var(--green);
        }

        .suggestion-improvement .label {
            font-size: 11px;
            color: var(--gray-500);
        }

        .btn-apply {
            padding: 8px 16px;
            background: var(--green);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
        }

        .btn-apply:hover {
            background: #138a3f;
        }

        /* Actions */
        .actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        /* Print Styles */
        .print-header {
            display: none;
        }

        .print-climate-note {
            display: none;
        }

        @media print {
            @page {
                size: A4;
                margin: 2mm 5mm;
            }

            body {
                background: white;
                font-size: 10px;
                line-height: 1.3;
            }

            .container {
                padding: 0;
                max-width: 100%;
            }

            .no-print { display: none !important; }
            #suggestions-card { display: none !important; }

            /* D√∂lj huvudheadern vid print */
            header { display: none !important; }

            .print-climate-note {
                display: none;
            }

            /* Print Header - kompakt 3-kolumn */
            .print-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 4px;
                padding-bottom: 3px;
                border-bottom: 2px solid var(--black);
                gap: 12px;
            }

            .print-header-left {
                flex: 0 0 auto;
            }

            .print-logos {
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .print-logos img {
                height: 20px;
            }

            .print-logos .print-ael-logo {
                height: 24px;
            }

            .print-logo-sep {
                color: var(--gray-400);
                font-size: 12px;
                font-weight: 300;
            }

            .print-header-center {
                flex: 1;
                text-align: center;
            }

            .print-header-center h2 {
                font-size: 12px;
                font-weight: 700;
                letter-spacing: 1px;
                margin: 0;
            }

            .print-header-center p {
                font-size: 9px;
                color: var(--gray-600);
                margin: 2px 0 0 0;
            }

            .print-header-right {
                flex: 0 0 auto;
                text-align: right;
            }

            .print-header-right p {
                font-size: 8px;
                color: var(--gray-600);
                margin: 0;
                line-height: 1.4;
            }

            /* Cards - minimal */
            .card {
                border: 1px solid #ccc;
                margin-bottom: 8px;
                padding: 8px 12px;
                break-inside: avoid;
            }

            .card-header {
                font-size: 9px;
                margin-bottom: 6px;
                padding-bottom: 4px;
            }

            /* Summary - 4 kolumner per rad, med separator */
            .summary-grid {
                display: flex;
                flex-wrap: wrap;
                gap: 0;
                border: none;
                background: none;
            }

            .summary-item {
                flex: 1 1 25%;
                padding: 6px 8px;
                text-align: center;
                border-right: 1px solid #ddd;
            }

            .summary-item:nth-child(4),
            .summary-item:nth-child(9) {
                border-right: none;
            }

            .summary-item .value {
                font-size: 16px;
            }

            .summary-item .label {
                font-size: 8px;
                margin-top: 2px;
            }

            .summary-material .value {
                font-size: 12px;
            }

            .summary-material .label {
                font-size: 8px;
                text-transform: none;
            }

            .summary-separator.print-only {
                display: block;
                width: 100%;
                height: 1px;
                background: #ccc;
                margin: 4px 0;
            }

            .summary-item.print-only {
                display: block;
            }

            /* Pattern Cards - ultrakompakt */
            .pattern-card {
                border: 1px solid #ccc;
                margin-bottom: 4px;
                break-inside: avoid;
            }

            .pattern-header {
                padding: 3px 8px;
                border-bottom: none;
            }

            .pattern-header h3 {
                font-size: 9px;
            }

            .pattern-count {
                font-size: 9px;
            }

            .pattern-count span {
                padding: 1px 4px;
                font-size: 8px;
            }

            /* Tube Visual - st√∂rre siffror, kompakt stapel */
            .tube-visual {
                height: 28px;
                margin: 2px 8px;
            }

            .tube-piece {
                font-size: 13px;
                font-weight: 700;
            }

            .tube-piece-label {
                padding: 0 2px;
            }

            .tube-waste {
                overflow: hidden;
            }

            .tube-waste span {
                font-size: 10px;
                padding: 0 3px;
            }

            .tube-fixture {
                font-size: 9px;
                min-width: 18px;
                overflow: hidden;
            }

            /* Annotations vid print */
            .tube-annotations {
                height: 16px;
                margin: 0 8px;
            }

            .annotation-text {
                font-size: 10px;
            }

            /* D√∂lj legend vid print - info r√§cker */
            .tube-legend {
                display: none;
            }

            /* Pattern Info - inline */
            .pattern-info {
                padding: 2px 8px;
                gap: 12px;
                font-size: 8px;
                border-top: none;
            }

            /* Verification - ultrakompakt */
            #verification-list {
                display: flex;
                flex-wrap: wrap;
                gap: 2px 8px;
            }

            .verification-item {
                padding: 2px 6px;
                font-size: 8px;
                border-bottom: none;
                border-left-width: 2px;
                flex: 0 0 auto;
            }

            .check-icon {
                font-size: 8px;
            }

            /* F√§rger vid utskrift */
            .tube-piece, .tube-waste, .tube-fixture,
            .color-0, .color-1, .color-2, .color-3, .color-4, .color-5,
            .pattern-count span, .summary-item {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }

        /* How it works section */
        .info-section {
            background: var(--white);
            border: 1px solid var(--gray-200);
            margin-bottom: 24px;
        }

        .info-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .info-toggle:hover {
            background: var(--gray-100);
        }

        .info-toggle h2 {
            font-size: 14px;
            font-weight: 600;
            color: var(--black);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-toggle .icon {
            font-size: 18px;
        }

        .info-toggle .arrow {
            font-size: 12px;
            color: var(--gray-500);
            transition: transform 0.2s;
        }

        .info-section.open .arrow {
            transform: rotate(180deg);
        }

        .info-content {
            display: none;
            padding: 0 24px 24px;
            border-top: 1px solid var(--gray-200);
        }

        .info-section.open .info-content {
            display: block;
        }

        .steps-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin: 20px 0;
        }

        .step {
            text-align: center;
        }

        .step-number {
            width: 36px;
            height: 36px;
            background: var(--black);
            color: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            margin: 0 auto 12px;
        }

        .step h3 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--black);
        }

        .step p {
            font-size: 12px;
            color: var(--gray-500);
            line-height: 1.4;
        }

        .terms-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--gray-200);
        }

        .term {
            background: var(--gray-100);
            padding: 14px;
        }

        .term strong {
            font-size: 12px;
            color: var(--black);
            display: block;
            margin-bottom: 4px;
        }

        .term span {
            font-size: 12px;
            color: var(--gray-500);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .form-grid {
                grid-template-columns: 1fr;
            }
            .header-top {
                padding: 16px 0;
            }
            .header-logos {
                gap: 16px;
            }
            .header-logos img:first-child {
                height: 36px;
            }
            .header-logos .ael-logo {
                height: 42px;
            }
            .logo-separator {
                font-size: 18px;
            }
            .header-bottom {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }
            header .header-nav {
                margin-left: 0;
            }
            .steps-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .terms-grid {
                grid-template-columns: 1fr;
            }
            .about-stats {
                grid-template-columns: 1fr;
            }
            .about-sections {
                grid-template-columns: 1fr;
            }
            .collab-logos {
                flex-direction: column;
                gap: 24px;
            }
            .about-section {
                padding: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <div class="header-logos">
                    <img src="/static/logo.png" alt="Hyllteknik">
                    <span class="logo-separator">√ó</span>
                    <img src="/static/ael-logo.png" alt="AI Empower Labs" class="ael-logo">
                </div>
            </div>
            <div class="header-divider"></div>
            <div class="header-bottom">
                <span class="tagline" data-i18n="tagline">Kapoptimering</span>
                <nav class="header-nav no-print">
                    <a onclick="showAbout()" class="nav-link" data-i18n="whyLink">Varf√∂r?</a>
                    <span class="nav-separator">|</span>
                    <div class="lang-switcher">
                        <a onclick="setLang('sv')" id="lang-sv" class="active">SV</a>
                        <span class="separator">/</span>
                        <a onclick="setLang('en')" id="lang-en">EN</a>
                    </div>
                </nav>
            </div>
        </header>

        <!-- About Section -->
        <div class="about-section no-print" id="about-section">
            <button class="about-close" onclick="hideAbout()" aria-label="St√§ng">&times;</button>
            <div class="about-hero">
                <h2 data-i18n="aboutHeroTitle">Varje millimeter r√§knas f√∂r klimatet</h2>
                <p data-i18n="aboutHeroDesc">Optimerad kapning minskar materialspill, s√§nker kostnader och reducerar milj√∂p√•verkan i verkstadsindustrin.</p>
            </div>

            <div class="about-stats">
                <div class="stat-card">
                    <div class="icon">üåç</div>
                    <div class="value">-15%</div>
                    <div class="label" data-i18n="statWaste">Materialspill</div>
                </div>
                <div class="stat-card">
                    <div class="icon">‚ö°</div>
                    <div class="value">10x</div>
                    <div class="label" data-i18n="statSpeed">Snabbare ber√§kning</div>
                </div>
                <div class="stat-card">
                    <div class="icon">üí∞</div>
                    <div class="value">+5%</div>
                    <div class="label" data-i18n="statMargin">Marginal per order</div>
                </div>
            </div>

            <div class="about-sections">
                <div class="about-card">
                    <h3><span class="icon">üå±</span> <span data-i18n="climateTitle">Klimatp√•verkan</span></h3>
                    <ul>
                        <li data-i18n="climatePoint1">Mindre spill = mindre r√•varuutvinning</li>
                        <li data-i18n="climatePoint2">Reducerad energif√∂rbrukning vid produktion</li>
                        <li data-i18n="climatePoint3">L√§gre transportbehov f√∂r material</li>
                        <li data-i18n="climatePoint4">Minskat avfall till √•tervinning</li>
                    </ul>
                </div>
                <div class="about-card">
                    <h3><span class="icon">‚è±Ô∏è</span> <span data-i18n="efficiencyTitle">Tid & Pengar</span></h3>
                    <ul>
                        <li data-i18n="efficiencyPoint1">Automatisk optimering ist√§llet f√∂r manuell ber√§kning</li>
                        <li data-i18n="efficiencyPoint2">Direkt visualisering av kapm√∂nster</li>
                        <li data-i18n="efficiencyPoint3">Spill√§tare-f√∂rslag f√∂r maximal effektivitet</li>
                        <li data-i18n="efficiencyPoint4">Utskriftsv√§nliga kapinstruktioner</li>
                    </ul>
                </div>
            </div>

            <div class="about-collab">
                <h3 data-i18n="collabTitle">Ett samarbete mellan</h3>
                <div class="collab-logos">
                    <img src="/static/logo.png" alt="Hyllteknik">
                    <span class="plus">+</span>
                    <img src="/static/ael-logo.png" alt="AI Empower Labs">
                </div>
                <p data-i18n="collabDesc">Hylltekniks djupa industrikunskap kombinerat med AI Empower Labs expertis inom AI och optimeringsalgoritmer.</p>
            </div>

            <div class="about-back">
                <button onclick="hideAbout()" data-i18n="backToApp">Tillbaka till appen</button>
            </div>
        </div>

        <!-- How it works -->
        <div class="info-section no-print" id="info-section">
            <div class="info-toggle" onclick="toggleInfo()">
                <h2><span class="icon">?</span> <span data-i18n="howItWorks">S√• h√§r funkar det</span></h2>
                <span class="arrow">‚ñº</span>
            </div>
            <div class="info-content">
                <div class="steps-grid">
                    <div class="step">
                        <div class="step-number">1</div>
                        <h3 data-i18n="step1Title">Ange parametrar</h3>
                        <p data-i18n="step1Desc">Fyll i ursprungsl√§ngd, fixturrest och kapklingans bredd</p>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <h3 data-i18n="step2Title">L√§gg till kapl√§ngder</h3>
                        <p data-i18n="step2Desc">Ange vilka l√§ngder du beh√∂ver och hur m√•nga av varje</p>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <h3 data-i18n="step3Title">Ber√§kna</h3>
                        <p data-i18n="step3Desc">Klicka p√• knappen f√∂r att optimera kapm√∂nstret</p>
                    </div>
                    <div class="step">
                        <div class="step-number">4</div>
                        <h3 data-i18n="step4Title">Se resultat</h3>
                        <p data-i18n="step4Desc">F√• visuella kapm√∂nster och se materialutnyttjande</p>
                    </div>
                </div>
                <div class="terms-grid">
                    <div class="term">
                        <strong data-i18n="termStock">Ursprungsl√§ngd</strong>
                        <span data-i18n="termStockDesc">L√§ngden p√• r√•materialet du kapar fr√•n (t.ex. 6000mm standardl√§ngd)</span>
                    </div>
                    <div class="term">
                        <strong data-i18n="termFixture">Fixturrest</strong>
                        <span data-i18n="termFixtureDesc">Den del som h√•lls fast i fixturen och inte kan kapas</span>
                    </div>
                    <div class="term">
                        <strong data-i18n="termKerf">Kapklinga</strong>
                        <span data-i18n="termKerfDesc">S√•gbladets bredd som g√•r f√∂rlorad vid varje snitt</span>
                    </div>
                    <div class="term">
                        <strong data-i18n="termJob">Jobbnamn & Material</strong>
                        <span data-i18n="termJobDesc">Frivilligt - visas p√• utskriften f√∂r att identifiera ordern</span>
                    </div>
                    <div class="term">
                        <strong data-i18n="termBuffer">Spill√§tare</strong>
                        <span data-i18n="termBufferDesc">F√∂rslag i resultatet p√• extra bitar som fyller ut spillet och √∂kar utnyttjandet</span>
                    </div>
                    <div class="term">
                        <strong data-i18n="termPrint">Skriv ut</strong>
                        <span data-i18n="termPrintDesc">Knapp i resultatet som skriver ut kapinstruktionen f√∂r operat√∂ren vid s√•gen</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Form -->
        <div id="input-section" class="no-print">
            <div class="card">
                <div class="card-header" data-i18n="jobInfo">Jobbinformation</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label data-i18n="jobName">Jobbnamn / Kund</label>
                        <input type="text" id="job_name" data-i18n-placeholder="jobNamePlaceholder" placeholder="Ange jobbnamn">
                    </div>
                    <div class="form-group">
                        <label data-i18n="materialType">Materialtyp</label>
                        <input type="text" id="material" data-i18n-placeholder="materialPlaceholder" placeholder="T.ex. Plattovalt 60x40x2mm">
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header" data-i18n="parameters">Parametrar</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label data-i18n="stockLength">Ursprungsl√§ngd (mm)</label>
                        <input type="number" id="stock_length" value="6000">
                    </div>
                    <div class="form-group">
                        <label data-i18n="fixtureRest">Fixturrest (mm)</label>
                        <input type="number" id="fixture_rest" value="50">
                    </div>
                    <div class="form-group">
                        <label data-i18n="sawKerf">Kapklinga (mm)</label>
                        <input type="number" id="saw_kerf" value="2.5" step="0.1">
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header" data-i18n="cutLengths">Kapl√§ngder</div>
                <div class="items-header">
                    <span data-i18n="length">L√§ngd (mm)</span>
                    <span data-i18n="quantity">Antal (st)</span>
                    <span></span>
                </div>
                <div id="items-list">
                    <div class="item-row">
                        <input type="number" class="item-length" placeholder="1240">
                        <input type="number" class="item-qty" placeholder="55">
                        <button class="btn-remove" onclick="removeItem(this)">&times;</button>
                    </div>
                </div>
                <button class="btn-add" onclick="addItem()" data-i18n="addRow">+ L√§gg till rad</button>
            </div>

            <button class="btn btn-run" id="run-btn" onclick="runOptimization()" data-i18n="calculate">
                Ber√§kna optimalt kapm√∂nster
            </button>
        </div>

        <!-- Results Section -->
        <div id="results">
            <div class="print-header">
                <div class="print-header-left">
                    <div class="print-logos">
                        <img src="/static/logo.png" alt="Hyllteknik">
                        <span class="print-logo-sep">√ó</span>
                        <img src="/static/ael-logo.png" alt="AI Empower Labs" class="print-ael-logo">
                    </div>
                </div>
                <div class="print-header-center">
                </div>
                <div class="print-header-right">
                    <h2 data-i18n="cutInstruction" style="font-size: 12px; font-weight: 700; letter-spacing: 1px; margin: 0;">KAPINSTRUKTION</h2>
                    <p id="print-job-info"></p>
                </div>
            </div>
            <p class="print-climate-note">1 sida = mindre klimatp√•verkan</p>

            <div class="card">
                <div class="card-header" data-i18n="summary">Sammanfattning</div>
                <div class="summary-grid" id="summary-grid"></div>
            </div>

            <div class="card">
                <div class="card-header" data-i18n="cutPatterns">Kapm√∂nster</div>
                <div id="patterns-container"></div>
            </div>

            <div class="card">
                <div class="card-header" data-i18n="verification">Kontroll</div>
                <div id="verification-list"></div>
            </div>

            <div class="card" id="suggestions-card" style="display: none;">
                <div class="card-header" data-i18n="suggestions">Optimeringsf√∂rslag</div>
                <div class="suggestions-intro" id="suggestions-intro"></div>
                <div id="suggestions-list"></div>
            </div>

            <div class="actions no-print">
                <button class="btn btn-primary" onclick="printPdf()" data-i18n="print">Skriv ut</button>
                <button class="btn btn-secondary" onclick="newOrder()" data-i18n="newOrder">Ny best√§llning</button>
            </div>
        </div>
    </div>

    <script>
        // Translations
        const translations = {
            sv: {
                tagline: 'Kapoptimering',
                howItWorks: 'S√• h√§r funkar det',
                step1Title: 'Ange parametrar',
                step1Desc: 'Fyll i ursprungsl√§ngd, fixturrest och kapklingans bredd',
                step2Title: 'L√§gg till kapl√§ngder',
                step2Desc: 'Ange vilka l√§ngder du beh√∂ver och hur m√•nga av varje',
                step3Title: 'Ber√§kna',
                step3Desc: 'Klicka p√• knappen f√∂r att optimera kapm√∂nstret',
                step4Title: 'Se resultat',
                step4Desc: 'F√• visuella kapm√∂nster och se materialutnyttjande',
                termStock: 'Ursprungsl√§ngd',
                termStockDesc: 'L√§ngden p√• r√•materialet du kapar fr√•n (t.ex. 6000mm standardl√§ngd)',
                termFixture: 'Fixturrest',
                termFixtureDesc: 'Den del som h√•lls fast i fixturen och inte kan kapas',
                termKerf: 'Kapklinga',
                termKerfDesc: 'S√•gbladets bredd som g√•r f√∂rlorad vid varje snitt',
                termJob: 'Jobbnamn & Material',
                termJobDesc: 'Frivilligt - visas p√• utskriften f√∂r att identifiera ordern',
                termBuffer: 'Spill√§tare',
                termBufferDesc: 'F√∂rslag i resultatet p√• extra bitar som fyller ut spillet och √∂kar utnyttjandet',
                termPrint: 'Skriv ut',
                termPrintDesc: 'Knapp i resultatet som skriver ut kapinstruktionen f√∂r operat√∂ren vid s√•gen',
                jobInfo: 'Jobbinformation',
                jobName: 'Jobbnamn / Kund',
                jobNamePlaceholder: 'Ange jobbnamn',
                materialType: 'Materialtyp',
                materialPlaceholder: 'T.ex. Plattovalt 60x40x2mm',
                parameters: 'Parametrar',
                stockLength: 'Ursprungsl√§ngd (mm)',
                fixtureRest: 'Fixturrest (mm)',
                sawKerf: 'Kapklinga (mm)',
                cutLengths: 'Kapl√§ngder',
                length: 'L√§ngd (mm)',
                quantity: 'Antal (st)',
                addRow: '+ L√§gg till rad',
                calculate: 'Ber√§kna optimalt kapm√∂nster',
                cutInstruction: 'KAPINSTRUKTION',
                summary: 'Sammanfattning',
                cutPatterns: 'Kapm√∂nster',
                verification: 'Kontroll',
                suggestions: 'Optimeringsf√∂rslag',
                print: 'Skriv ut',
                newOrder: 'Ny best√§llning',
                totalTubes: 'Antal l√§ngder',
                totalWaste: 'Totalt spill',
                materialUsage: 'Material√•tg√•ng',
                utilization: 'Utnyttjande',
                pattern: 'M√∂nster',
                count: 'Antal:',
                cut: 'Kap:',
                waste: 'Spill:',
                perTube: '/l√§ngd',
                produced: 'produceras',
                ordered: 'Best√§llt:',
                pcs: 'st',
                utilizationIs: 'Utnyttjandet √§r',
                bufferIntro: 'Genom att l√§gga till extra bitar ("spill√§tare") kan du f√∂rb√§ttra materialutnyttjandet. Dessa bitar kan anv√§ndas till framtida ordrar eller som reservdelar.',
                addBuffer: 'L√§gg till',
                newUtil: 'Nytt utnyttjande:',
                reducesWaste: 'Minskar spill med',
                improvement: 'f√∂rb√§ttring',
                noItems: 'L√§gg till minst en kapl√§ngd',
                calculating: 'Ber√§knar...',
                errorOptimizing: 'Fel vid optimering:',
                // About section
                whyLink: 'Varf√∂r?',
                aboutHeroTitle: 'Varje millimeter r√§knas f√∂r klimatet',
                aboutHeroDesc: 'Optimerad kapning minskar materialspill, s√§nker kostnader och reducerar milj√∂p√•verkan i verkstadsindustrin.',
                statWaste: 'Materialspill',
                statSpeed: 'Snabbare ber√§kning',
                statMargin: 'Marginal per order',
                climateTitle: 'Klimatp√•verkan',
                climatePoint1: 'Mindre spill = mindre r√•varuutvinning',
                climatePoint2: 'Reducerad energif√∂rbrukning vid produktion',
                climatePoint3: 'L√§gre transportbehov f√∂r material',
                climatePoint4: 'Minskat avfall till √•tervinning',
                efficiencyTitle: 'Tid & Pengar',
                efficiencyPoint1: 'Automatisk optimering ist√§llet f√∂r manuell ber√§kning',
                efficiencyPoint2: 'Direkt visualisering av kapm√∂nster',
                efficiencyPoint3: 'Spill√§tare-f√∂rslag f√∂r maximal effektivitet',
                efficiencyPoint4: 'Utskriftsv√§nliga kapinstruktioner',
                collabTitle: 'Ett samarbete mellan',
                collabDesc: 'Hylltekniks djupa industrikunskap kombinerat med AI Empower Labs expertis inom AI och optimeringsalgoritmer.',
                backToApp: 'Tillbaka till appen'
            },
            en: {
                tagline: 'Cut Optimization',
                howItWorks: 'How it works',
                step1Title: 'Set parameters',
                step1Desc: 'Enter stock length, fixture rest and saw kerf width',
                step2Title: 'Add cut lengths',
                step2Desc: 'Specify the lengths you need and how many of each',
                step3Title: 'Calculate',
                step3Desc: 'Click the button to optimize the cutting pattern',
                step4Title: 'View results',
                step4Desc: 'Get visual cutting patterns and see material utilization',
                termStock: 'Stock length',
                termStockDesc: 'The length of the raw material you cut from (e.g. 6000mm standard length)',
                termFixture: 'Fixture rest',
                termFixtureDesc: 'The part held in the fixture that cannot be cut',
                termKerf: 'Saw kerf',
                termKerfDesc: 'The width of the saw blade lost with each cut',
                termJob: 'Job name & Material',
                termJobDesc: 'Optional - shown on printout to identify the order',
                termBuffer: 'Buffer pieces',
                termBufferDesc: 'Suggestions in the result for extra pieces that fill waste and increase utilization',
                termPrint: 'Print',
                termPrintDesc: 'Button in the result that prints the cutting instruction for the operator at the saw',
                jobInfo: 'Job Information',
                jobName: 'Job Name / Customer',
                jobNamePlaceholder: 'Enter job name',
                materialType: 'Material Type',
                materialPlaceholder: 'E.g. Flat oval 60x40x2mm',
                parameters: 'Parameters',
                stockLength: 'Stock Length (mm)',
                fixtureRest: 'Fixture Rest (mm)',
                sawKerf: 'Saw Kerf (mm)',
                cutLengths: 'Cut Lengths',
                length: 'Length (mm)',
                quantity: 'Quantity (pcs)',
                addRow: '+ Add row',
                calculate: 'Calculate optimal cutting pattern',
                cutInstruction: 'CUT INSTRUCTION',
                summary: 'Summary',
                cutPatterns: 'Cutting Patterns',
                verification: 'Verification',
                suggestions: 'Optimization Suggestions',
                print: 'Print',
                newOrder: 'New Order',
                totalTubes: 'Total lengths',
                totalWaste: 'Total waste',
                materialUsage: 'Material usage',
                utilization: 'Utilization',
                pattern: 'Pattern',
                count: 'Count:',
                cut: 'Cut:',
                waste: 'Waste:',
                perTube: '/length',
                produced: 'produced',
                ordered: 'Ordered:',
                pcs: 'pcs',
                utilizationIs: 'Utilization is',
                bufferIntro: 'By adding extra pieces ("buffer pieces") you can improve material utilization. These pieces can be used for future orders or as spare parts.',
                addBuffer: 'Add',
                newUtil: 'New utilization:',
                reducesWaste: 'Reduces waste by',
                improvement: 'improvement',
                noItems: 'Add at least one cut length',
                calculating: 'Calculating...',
                errorOptimizing: 'Error optimizing:',
                // About section
                whyLink: 'Why?',
                aboutHeroTitle: 'Every millimeter counts for the climate',
                aboutHeroDesc: 'Optimized cutting reduces material waste, lowers costs and reduces environmental impact in the manufacturing industry.',
                statWaste: 'Material waste',
                statSpeed: 'Faster calculation',
                statMargin: 'Margin per order',
                climateTitle: 'Climate Impact',
                climatePoint1: 'Less waste = less raw material extraction',
                climatePoint2: 'Reduced energy consumption in production',
                climatePoint3: 'Lower transportation needs for materials',
                climatePoint4: 'Reduced waste for recycling',
                efficiencyTitle: 'Time & Money',
                efficiencyPoint1: 'Automatic optimization instead of manual calculation',
                efficiencyPoint2: 'Instant visualization of cutting patterns',
                efficiencyPoint3: 'Buffer piece suggestions for maximum efficiency',
                efficiencyPoint4: 'Print-friendly cutting instructions',
                collabTitle: 'A collaboration between',
                collabDesc: 'Hyllteknik\'s deep industry knowledge combined with AI Empower Labs\' expertise in AI and optimization algorithms.',
                backToApp: 'Back to the app'
            }
        };

        let currentLang = localStorage.getItem('lang') || 'sv';

        function setLang(lang) {
            currentLang = lang;
            localStorage.setItem('lang', lang);
            applyTranslations();
            updateLangButtons();
        }

        function applyTranslations() {
            const t = translations[currentLang];

            // Update text content
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    el.textContent = t[key];
                }
            });

            // Update placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (t[key]) {
                    el.placeholder = t[key];
                }
            });
        }

        function updateLangButtons() {
            document.getElementById('lang-sv').classList.toggle('active', currentLang === 'sv');
            document.getElementById('lang-en').classList.toggle('active', currentLang === 'en');
        }

        function t(key) {
            return translations[currentLang][key] || key;
        }

        // Initialize language on load
        document.addEventListener('DOMContentLoaded', () => {
            applyTranslations();
            updateLangButtons();
        });

        // Toggle info section
        function toggleInfo() {
            document.getElementById('info-section').classList.toggle('open');
        }

        // About section toggle
        function showAbout() {
            const aboutSection = document.getElementById('about-section');
            const isVisible = aboutSection.classList.contains('visible');

            if (isVisible) {
                hideAbout();
            } else {
                aboutSection.classList.add('visible');
                document.getElementById('info-section').style.display = 'none';
                document.getElementById('input-section').style.display = 'none';
                document.getElementById('results').style.display = 'none';
                document.querySelector('.nav-link').classList.add('active');
            }
        }

        function hideAbout() {
            document.getElementById('about-section').classList.remove('visible');
            document.getElementById('info-section').style.display = '';
            document.getElementById('input-section').style.display = '';
            document.querySelector('.nav-link').classList.remove('active');
        }

        const colorMap = {};
        let colorIndex = 0;

        function getColor(length) {
            if (!(length in colorMap)) {
                colorMap[length] = colorIndex % 6;
                colorIndex++;
            }
            return `color-${colorMap[length]}`;
        }

        function addItem() {
            const list = document.getElementById('items-list');
            const row = document.createElement('div');
            row.className = 'item-row';
            row.innerHTML = `
                <input type="number" class="item-length" placeholder="L√§ngd">
                <input type="number" class="item-qty" placeholder="Antal">
                <button class="btn-remove" onclick="removeItem(this)">&times;</button>
            `;
            list.appendChild(row);
        }

        function removeItem(btn) {
            const rows = document.querySelectorAll('.item-row');
            if (rows.length > 1) {
                btn.parentElement.remove();
            }
        }

        function getFormData() {
            const items = [];
            document.querySelectorAll('.item-row').forEach(row => {
                const length = row.querySelector('.item-length').value;
                const qty = row.querySelector('.item-qty').value;
                if (length && qty) {
                    items.push({ length: parseInt(length), quantity: parseInt(qty) });
                }
            });

            return {
                job_name: document.getElementById('job_name').value,
                material: document.getElementById('material').value,
                stock_length: parseFloat(document.getElementById('stock_length').value),
                fixture_rest: parseFloat(document.getElementById('fixture_rest').value),
                saw_kerf: parseFloat(document.getElementById('saw_kerf').value),
                items: items
            };
        }

        async function runOptimization() {
            const data = getFormData();

            if (data.items.length === 0) {
                alert(t('noItems'));
                return;
            }

            // Show loading state
            const btn = document.getElementById('run-btn');
            const originalText = btn.textContent;
            btn.textContent = t('calculating');
            btn.disabled = true;
            btn.style.opacity = '0.7';

            Object.keys(colorMap).forEach(k => delete colorMap[k]);
            colorIndex = 0;

            try {
                const response = await fetch('/optimize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.error) {
                    alert(result.error);
                    return;
                }

                displayResults(result);

            } catch (error) {
                console.error('Error:', error);
                alert(t('errorOptimizing') + ' ' + error.message);
            } finally {
                // Reset button
                btn.textContent = originalText;
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        }

        function displayResults(result) {
            document.getElementById('input-section').style.display = 'none';
            document.getElementById('results').style.display = 'block';

            const notSpecified = currentLang === 'sv' ? 'Ej angivet' : 'Not specified';

            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            const dateStr = now.getFullYear() + '-' + (now.getMonth() + 1).toString().padStart(2, '0') + '-' + now.getDate().toString().padStart(2, '0');

            document.getElementById('print-job-info').innerHTML = `${dateStr} ${timeStr}`;
            const summaryHtml = `
                <div class="summary-item summary-material">
                    <div class="value">${result.material || '‚Äî'}</div>
                    <div class="label">${result.job_name || '‚Äî'}</div>
                </div>
                <div class="summary-item">
                    <div class="value">${result.summary.total_tubes}</div>
                    <div class="label">${t('totalTubes')}</div>
                </div>
                <div class="summary-item">
                    <div class="value">${result.summary.total_material_m}m</div>
                    <div class="label">${t('materialUsage')}</div>
                </div>
                <div class="summary-item">
                    <div class="value">${result.summary.utilization}%</div>
                    <div class="label">${t('utilization')}</div>
                </div>
                <div class="summary-separator print-only"></div>
                <div class="summary-item print-only">
                    <div class="value">${result.parameters.stock_length}</div>
                    <div class="label">${currentLang === 'sv' ? 'URSPRUNGSL√ÑNGD (MM)' : 'STOCK LENGTH (MM)'}</div>
                </div>
                <div class="summary-item print-only">
                    <div class="value">${result.parameters.fixture_rest}</div>
                    <div class="label">${currentLang === 'sv' ? 'FIXTURREST (MM)' : 'FIXTURE REST (MM)'}</div>
                </div>
                <div class="summary-item print-only">
                    <div class="value">${result.parameters.saw_kerf}</div>
                    <div class="label">${currentLang === 'sv' ? 'KAPKLINGA (MM)' : 'SAW KERF (MM)'}</div>
                </div>
                <div class="summary-item print-only">
                    <div class="value">${result.summary.total_waste_m}m</div>
                    <div class="label">${t('totalWaste')}</div>
                </div>
            `;
            document.getElementById('summary-grid').innerHTML = summaryHtml;

            const usableLength = result.parameters.usable_length;
            const stockLength = result.parameters.stock_length;
            const fixtureRest = result.parameters.fixture_rest;

            let patternsHtml = '';
            result.patterns.forEach((pattern, idx) => {
                let tubeHtml = '';
                let legendHtml = '';
                let position = 0;
                const scale = 100 / stockLength;
                const sawKerf = result.parameters.saw_kerf;

                // Group pieces by length
                const grouped = {};
                pattern.pieces.forEach(piece => {
                    if (!grouped[piece.length]) {
                        grouped[piece.length] = { length: piece.length, count: 0 };
                    }
                    grouped[piece.length].count++;
                });

                // Sort by length descending
                const sortedGroups = Object.values(grouped).sort((a, b) => b.length - a.length);

                // Draw grouped pieces
                sortedGroups.forEach((group) => {
                    const totalWidth = (group.length * group.count + sawKerf * group.count) * scale;
                    const colorClass = getColor(group.length);

                    // Label for the group
                    const label = group.count > 1 ? `${group.count}√ó ${group.length}` : `${group.length}mm`;

                    tubeHtml += `
                        <div class="tube-piece ${colorClass}"
                             style="left: ${position * scale}%; width: ${(group.length * group.count + sawKerf * (group.count - 1)) * scale}%;"
                             title="${group.count}st √ó ${group.length}mm">
                            <span class="tube-piece-label">${label}</span>
                        </div>
                    `;

                    // Add to legend
                    legendHtml += `
                        <div class="legend-item">
                            <div class="legend-color ${colorClass}"></div>
                            <span>${group.count}√ó ${group.length}mm</span>
                        </div>
                    `;

                    position += group.length * group.count + sawKerf * group.count;
                });

                // Calculate remaining space for waste
                const usedWidth = position * scale;
                const fixtureWidth = Math.max(fixtureRest * scale, 3);
                const wasteWidth = Math.max(0, 100 - usedWidth - fixtureWidth);

                // Waste (only if there's meaningful waste)
                if (pattern.waste > 10) {
                    tubeHtml += `
                        <div class="tube-waste"
                             style="left: ${usedWidth}%; width: ${wasteWidth}%;">
                            <span>${Math.round(pattern.waste)}mm</span>
                        </div>
                    `;
                } else if (pattern.waste > 0) {
                    tubeHtml += `
                        <div class="tube-waste"
                             style="left: ${usedWidth}%; width: ${wasteWidth}%;">
                        </div>
                    `;
                }

                // Fixture - always on the right
                tubeHtml += `
                    <div class="tube-fixture" style="width: ${fixtureWidth}%;">
                        FIX
                    </div>
                `;

                const patternDesc = Object.entries(pattern.counts)
                    .filter(([_, count]) => count > 0)
                    .sort((a, b) => parseInt(b[0]) - parseInt(a[0]))
                    .map(([length, count]) => count > 1 ? `${count}√ó ${length}` : `${length}`)
                    .join(' + ');

                patternsHtml += `
                    <div class="pattern-card">
                        <div class="pattern-header">
                            <h3>${t('pattern')} ${idx + 1}</h3>
                            <div class="pattern-count">${t('count')}<span>${pattern.tube_count} ${t('pcs')}</span></div>
                        </div>
                        <div class="tube-visual">${tubeHtml}</div>
                        <div class="tube-legend">${legendHtml}</div>
                        <div class="pattern-info">
                            <span><strong>${t('cut')}</strong> ${patternDesc} mm</span>
                            <span><strong>${t('waste')}</strong> ${Math.round(pattern.waste)} mm${t('perTube')}</span>
                        </div>
                    </div>
                `;
            });
            document.getElementById('patterns-container').innerHTML = patternsHtml;

            let verificationHtml = '';
            result.verification.forEach(item => {
                const statusClass = item.ok ? 'ok' : 'error';
                const icon = item.ok ? '‚úì' : '‚úó';
                const extra = item.produced > item.needed ? ` (+${item.produced - item.needed})` : '';
                verificationHtml += `
                    <div class="verification-item ${statusClass}">
                        <span><strong>L-${item.length}mm</strong> ‚Äî ${item.produced} ${t('pcs')} ${t('produced')}${extra}</span>
                        <span style="margin-left: 8px;">${t('ordered')} ${item.needed} ${t('pcs')}</span>
                        <span class="check-icon ${statusClass}">${icon}</span>
                    </div>
                `;
            });
            document.getElementById('verification-list').innerHTML = verificationHtml;

            // Display buffer suggestions if available
            const suggestionsCard = document.getElementById('suggestions-card');
            const suggestionsList = document.getElementById('suggestions-list');
            const suggestionsIntro = document.getElementById('suggestions-intro');

            if (result.buffer_suggestions && result.buffer_suggestions.length > 0) {
                suggestionsCard.style.display = 'block';

                const tubesWord = currentLang === 'sv' ? 'l√§ngder' : 'lengths';
                suggestionsIntro.innerHTML = `
                    <strong>${t('utilizationIs')} ${result.summary.utilization}%</strong><br>
                    ${t('bufferIntro')}
                `;

                let suggestionsHtml = '';
                result.buffer_suggestions.forEach(s => {
                    suggestionsHtml += `
                        <div class="suggestion-item">
                            <div class="suggestion-main">
                                <span class="suggestion-title">${t('addBuffer')} ${s.quantity}${t('pcs')} √ó ${s.length}mm</span>
                                <span class="suggestion-detail">
                                    ${t('newUtil')} ${s.new_utilization}% |
                                    ${t('reducesWaste')} ${s.waste_reduction}m
                                    ${s.extra_tubes > 0 ? `| +${s.extra_tubes} ${tubesWord}` : ''}
                                </span>
                            </div>
                            <div class="suggestion-improvement">
                                <div class="value">+${s.improvement}%</div>
                                <div class="label">${t('improvement')}</div>
                            </div>
                            <button class="btn-apply" onclick="applySuggestion(${s.length}, ${s.quantity})">
                                ${t('addBuffer')}
                            </button>
                        </div>
                    `;
                });
                suggestionsList.innerHTML = suggestionsHtml;
            } else {
                suggestionsCard.style.display = 'none';
            }
        }

        function applySuggestion(length, quantity) {
            // G√• tillbaka till input och l√§gg till l√§ngden
            document.getElementById('results').style.display = 'none';
            document.getElementById('input-section').style.display = 'block';

            // Kolla om l√§ngden redan finns
            let found = false;
            document.querySelectorAll('.item-row').forEach(row => {
                const lengthInput = row.querySelector('.item-length');
                if (parseInt(lengthInput.value) === length) {
                    const qtyInput = row.querySelector('.item-qty');
                    qtyInput.value = parseInt(qtyInput.value || 0) + quantity;
                    found = true;
                }
            });

            // Om inte, l√§gg till ny rad
            if (!found) {
                const list = document.getElementById('items-list');
                const row = document.createElement('div');
                row.className = 'item-row';
                row.innerHTML = `
                    <input type="number" class="item-length" value="${length}">
                    <input type="number" class="item-qty" value="${quantity}">
                    <button class="btn-remove" onclick="removeItem(this)">&times;</button>
                `;
                list.appendChild(row);
            }

            // Scrolla till l√§ngderna
            document.getElementById('items-list').scrollIntoView({ behavior: 'smooth' });
        }

        function printPdf() {
            const originalTitle = document.title;
            const now = new Date();
            const y = now.getFullYear();
            const mo = (now.getMonth() + 1).toString().padStart(2, '0');
            const d = now.getDate().toString().padStart(2, '0');
            const h = now.getHours().toString().padStart(2, '0');
            const mi = now.getMinutes().toString().padStart(2, '0');
            document.title = `Kapinstruktion_${y}_${mo}_${d}_${h}_${mi}`;
            window.print();
            document.title = originalTitle;
        }

        function newOrder() {
            document.getElementById('results').style.display = 'none';
            document.getElementById('input-section').style.display = 'block';
        }

        // Enter f√∂r att hoppa till n√§sta f√§lt
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.target.tagName === 'INPUT') {
                e.preventDefault();

                // Kolla om vi √§r i ett antal-f√§lt i kapl√§ngder
                if (e.target.classList.contains('item-qty')) {
                    // L√§gg till ny rad och fokusera p√• l√§ngd-f√§ltet
                    addItem();
                    const rows = document.querySelectorAll('.item-row');
                    const lastRow = rows[rows.length - 1];
                    const lengthInput = lastRow.querySelector('.item-length');
                    lengthInput.focus();
                } else {
                    // Hitta alla synliga input-f√§lt
                    const inputs = Array.from(document.querySelectorAll('input:not([type="hidden"])'))
                        .filter(input => input.offsetParent !== null);
                    const currentIndex = inputs.indexOf(e.target);

                    if (currentIndex > -1 && currentIndex < inputs.length - 1) {
                        inputs[currentIndex + 1].focus();
                    }
                }
            }
        });

        // Ctrl+E f√∂r exempeldata
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                document.getElementById('job_name').value = 'Peters kaplista';
                document.getElementById('material').value = 'Plattovalt 60x40x2mm';

                const items = [
                    {length: 1240, qty: 55},
                    {length: 1150, qty: 160},
                    {length: 567, qty: 136},
                    {length: 530, qty: 80},
                    {length: 235, qty: 250}
                ];

                const list = document.getElementById('items-list');
                list.innerHTML = '';

                items.forEach((item) => {
                    const row = document.createElement('div');
                    row.className = 'item-row';
                    row.innerHTML = `
                        <input type="number" class="item-length" value="${item.length}">
                        <input type="number" class="item-qty" value="${item.qty}">
                        <button class="btn-remove" onclick="removeItem(this)">&times;</button>
                    `;
                    list.appendChild(row);
                });
            }
        });
    </script>
</body>
</html>
